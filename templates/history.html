<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>播放记录 - 动画视频网站</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .history-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .history-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary {
            background-color: #4285f4;
            color: white;
        }
        .btn-primary:hover {
            background-color: #3367d6;
        }
        .btn-danger {
            background-color: #ea4335;
            color: white;
        }
        .btn-danger:hover {
            background-color: #d3302f;
        }
        .empty-history {
            text-align: center;
            padding: 60px 20px;
            color: #666;
            background-color: #f5f5f5;
            border-radius: 8px;
            margin: 20px 0;
        }
        .empty-history h3 {
            margin-bottom: 10px;
            color: #333;
        }
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .history-item {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            transition: all 0.3s ease;
        }
        .history-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .anime-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        .episode-info {
            font-size: 14px;
            color: #666;
            margin: 5px 0;
        }
        .progress-container {
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }
        .progress-fill {
            height: 100%;
            background-color: #4285f4;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        .history-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .last-played {
            font-size: 12px;
            color: #888;
        }
        .play-button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .play-button:hover {
            background-color: #3367d6;
        }
        .clear-all-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .clear-all-btn:hover {
            background-color: #d32f2f;
        }
        .group-title {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 2px solid #4285f4;
        }
        .history-stats {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="site-header">
            <a href="/" class="back-btn">← 返回首页</a>
            <h1>播放记录</h1>
        </header>

        <main>
            <div class="history-container">
                <div class="history-header">
                    <div>
                        <h1 class="history-title">我的播放记录</h1>
                        <div class="history-stats" id="historyStats">
                            共 <span id="recordCount">0</span> 条播放记录
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-danger" id="clearAllBtn">清除所有记录</button>
                    </div>
                </div>

                <!-- 空记录提示 -->
                <div class="empty-history" id="emptyHistory">
                    <h3>暂无播放记录</h3>
                    <p>快去观看一些动画，记录会自动保存</p>
                    <a href="/" class="btn btn-primary" style="margin-top: 15px;">去首页观看</a>
                </div>

                <!-- 播放记录列表 -->
                <div class="history-list" id="historyList"></div>
            </div>
        </main>

        <footer class="site-footer">
            <p>© 2026 动画视频网站 | 本网站仅用于学习交流</p>
        </footer>
    </div>

    <script>
        // 播放记录存储相关
        const HISTORY_KEY = 'anime_play_history';

        // 格式化时间
        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 60) {
                return `${minutes}分钟前`;
            } else if (hours < 24) {
                return `${hours}小时前`;
            } else if (days < 7) {
                return `${days}天前`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // 格式化秒数为时间格式 HH:MM:SS
        function formatSeconds(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            
            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        // 渲染播放记录
        function renderHistory() {
            const history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            const historyList = document.getElementById('historyList');
            const emptyHistory = document.getElementById('emptyHistory');
            const recordCount = document.getElementById('recordCount');
            
            recordCount.textContent = history.length;
            
            if (history.length === 0) {
                emptyHistory.style.display = 'block';
                historyList.innerHTML = '';
                return;
            }
            
            emptyHistory.style.display = 'none';
            
            // 按动画分组，每个动画只保留一条最新记录
            const groupedHistory = {};
            history.forEach(item => {
                // 只保留videoUrl不为空的记录
                if (!item.videoUrl) return;
                
                // 如果是该动画的第一条记录，或者比现有记录更新，则更新
                if (!groupedHistory[item.animeTitle] || 
                    new Date(item.lastPlayed) > new Date(groupedHistory[item.animeTitle].lastPlayed)) {
                    groupedHistory[item.animeTitle] = item;
                }
            });
            
            // 渲染分组后的记录
            let html = '';
            Object.keys(groupedHistory).forEach(animeTitle => {
                const item = groupedHistory[animeTitle];
                const progress = Math.round(item.progress);
                const currentTime = formatSeconds(item.currentTime);
                const duration = formatSeconds(item.duration);
                const lastPlayed = formatTime(item.lastPlayed);
                
                // 对动画标题和集数进行URL解码
                let decodedAnimeTitle = animeTitle;
                let decodedEpisode = item.episode;
                try {
                    decodedAnimeTitle = decodeURIComponent(animeTitle);
                    decodedEpisode = decodeURIComponent(item.episode);
                } catch (e) {
                    console.error('URL解码失败:', e);
                }
                
                html += `<h2 class="group-title">${decodedAnimeTitle}</h2>`;
                
                html += `
                <div class="history-item">
                    <div class="history-item-header">
                        <div>
                            <h3 class="anime-title">${decodedAnimeTitle}</h3>
                            <div class="episode-info">${decodedEpisode}</div>
                        </div>
                        <div class="last-played">${lastPlayed}</div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="progress-text">
                            <span>已观看 ${progress}%</span>
                            <span>${currentTime} / ${duration}</span>
                        </div>
                    </div>
                    
                    <div class="history-item-footer">
                        <button class="play-button" 
                                data-videourl="${item.videoUrl}"
                                data-title="${decodedAnimeTitle}-${decodedEpisode}"
                                data-currenttime="${item.currentTime}">
                            继续播放
                        </button>
                        <button class="btn btn-danger" 
                                data-videourl="${item.videoUrl}" style="padding: 6px 12px; font-size: 12px;">
                            删除记录
                        </button>
                    </div>
                </div>
                `;
            });
            
            historyList.innerHTML = html;
        }

        // 继续播放
        function continuePlay(videoUrl, title, currentTime) {
            // 构建播放URL，包含当前进度
            const playUrl = `/play?video=${encodeURIComponent(videoUrl)}&title=${encodeURIComponent(title)}&currentTime=${currentTime}`;
            window.location.href = playUrl;
        }

        // 删除单条记录
        function deleteRecord(videoUrl) {
            if (confirm('确定要删除这条播放记录吗？')) {
                let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
                history = history.filter(item => item.videoUrl !== videoUrl);
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
                renderHistory();
            }
        }

        // 清除所有记录
        function clearAllHistory() {
            if (confirm('确定要清除所有播放记录吗？此操作不可恢复！')) {
                localStorage.removeItem(HISTORY_KEY);
                renderHistory();
            }
        }

        // 页面加载完成后绑定事件
        document.addEventListener('DOMContentLoaded', () => {
            renderHistory();
            
            // 绑定清除所有记录按钮
            document.getElementById('clearAllBtn').addEventListener('click', clearAllHistory);
            
            // 使用事件委托绑定继续播放和删除记录按钮事件
            document.getElementById('historyList').addEventListener('click', (e) => {
                // 继续播放按钮
                if (e.target.classList.contains('play-button')) {
                    const videoUrl = e.target.getAttribute('data-videourl');
                    const title = e.target.getAttribute('data-title');
                    const currentTime = e.target.getAttribute('data-currenttime');
                    continuePlay(videoUrl, title, currentTime);
                }
                // 删除记录按钮
                else if (e.target.classList.contains('btn-danger') && e.target.textContent.includes('删除记录')) {
                    const videoUrl = e.target.getAttribute('data-videourl');
                    deleteRecord(videoUrl);
                }
            });
        });
    </script>
</body>
</html>