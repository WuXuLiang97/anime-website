<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>批量生成HLS切片</title>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/static/css/style.css" />
  <style>
    .header {
      text-align: center;
      margin-bottom: 40px;
    }

    .header h1 {
      color: #333;
    }

    .controls {
      background-color: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .controls h2 {
      margin-top: 0;
      color: #333;
    }

    .btn {
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .btn:hover {
      background-color: #3367d6;
    }

    .btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .progress-section {
      margin-bottom: 30px;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: #e0e0e0;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background-color: #4285f4;
      transition: width 0.3s ease;
      border-radius: 10px;
    }

    .progress-text {
      font-size: 14px;
      color: #666;
    }

    .status-section {
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .status-section h2 {
      margin-top: 0;
      color: #333;
    }

    .status-log {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 10px;
      background-color: #ffffff;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.4;
    }

    .status-log .log-entry {
      margin-bottom: 5px;
    }

    .status-log .log-info {
      color: #333;
    }

    .status-log .log-success {
      color: #34a853;
    }

    .status-log .log-error {
      color: #ea4335;
    }

    .result-section {
      background-color: #f0f7ff;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
    }

    .result-section h2 {
      margin-top: 0;
      color: #333;
    }

    .result-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }

    .stat-item {
      background-color: #ffffff;
      padding: 15px;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      min-width: 120px;
    }

    .stat-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .error-list {
      background-color: #fff3f3;
      padding: 15px;
      border-radius: 4px;
      border-left: 4px solid #ea4335;
    }

    .error-list h3 {
      margin-top: 0;
      color: #ea4335;
    }

    .error-list ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .error-list li {
      margin-bottom: 5px;
      font-size: 14px;
    }

    .checkbox-group {
      margin-bottom: 20px;
    }

    .checkbox-group label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 16px;
      cursor: pointer;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      max-width: 300px;
    }

    .search-input {
      flex: 1;
      padding: 12px 16px;
      font-size: 16px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      outline: none;
      transition: border-color 0.3s ease;
    }

    .search-input:focus {
      border-color: #4285f4;
    }

    .search-results {
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background-color: #ffffff;
      min-height: 100px;
    }

    .result-item {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #f0f0f0;
    }

    .anime-info {
      flex: 1;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-item:hover {
      background-color: #f5f5f5;
    }

    .delete-btn {
      margin-left: auto;
      background-color: #ea4335;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .delete-btn:hover {
      background-color: #d33a2b;
    }
  </style>
</head>

<body>
  <div class="bili-header">
    <div class="bili-header__bar">
      <ul class="left-entry">
        <li>
          <a href="/" class="entry-title"> <img src="static/1.bmp" class="bili-logo">首页</a>
        </li>

      </ul>

    </div>
    <div class="container">


      <section class="controls">
        <h2>控制选项</h2>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" id="useGPU" checked>
            使用GPU加速（更快的处理速度）
          </label>
        </div>
        <button id="startBtn" class="btn">开始批量生成HLS切片</button>
        <button id="stopBtn" class="btn" disabled>停止处理</button>
        <button id="scanBtn" class="btn" style="margin-left: 10px;">扫描视频</button>
      </section>

      <section class="progress-section">
        <h2>处理进度</h2>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 0%"></div>
        </div>
        <div class="progress-text">
          <span id="progressCurrent">0</span> / <span id="progressTotal">0</span> 视频
          <span id="progressPercent">(0%)</span>
        </div>
      </section>

      <section class="status-section">
        <h2>处理状态</h2>
        <div class="status-log" id="statusLog">
          <div class="log-entry log-info">系统就绪，点击"开始批量生成HLS切片"按钮开始处理。</div>
        </div>
      </section>

      <section class="result-section" id="resultSection" style="display: none;">
        <h2>处理结果</h2>
        <div class="result-stats">
          <div class="stat-item">
            <div class="stat-label">总视频数</div>
            <div class="stat-value" id="totalVideos">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">成功生成</div>
            <div class="stat-value" id="successVideos">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">失败数量</div>
            <div class="stat-value" id="failedVideos">0</div>
          </div>
        </div>
        <div class="error-list" id="errorList" style="display: none;">
          <h3>失败视频列表</h3>
          <ul id="errorItems"></ul>
        </div>
      </section>
      <h2>动画管理</h2>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="输入动画名称进行搜索..." class="search-input">
        <button id="searchBtn" class="btn">搜索</button>
      </div>
      <div class="search-results" id="searchResults">
        <div class="result-item" id="noResults" style="display: none;">
          没有找到匹配的动画
        </div>
      </div>

      <footer class="site-footer">
        <p>© 2026 动画视频网站 | 本网站仅用于学习交流</p>
      </footer>
    </div>

    <script>
      // 全局变量
      let isProcessing = false;
      let lastResponseLength = 0;
      let currentProcessId = null;

      // DOM元素
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const scanBtn = document.getElementById('scanBtn');
      const useGPUCheckbox = document.getElementById('useGPU');
      const progressFill = document.querySelector('.progress-fill');
      const progressCurrent = document.getElementById('progressCurrent');
      const progressTotal = document.getElementById('progressTotal');
      const progressPercent = document.getElementById('progressPercent');
      const statusLog = document.getElementById('statusLog');
      const resultSection = document.getElementById('resultSection');
      const totalVideos = document.getElementById('totalVideos');
      const successVideos = document.getElementById('successVideos');
      const failedVideos = document.getElementById('failedVideos');
      const errorList = document.getElementById('errorList');
      const errorItems = document.getElementById('errorItems');

      // 日志记录函数
      function addLog(message, type = 'info') {
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry log-${type}`;
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        statusLog.appendChild(logEntry);
        statusLog.scrollTop = statusLog.scrollHeight;
      }

      // 更新进度条
      function updateProgress(current, total) {
        const percent = total > 0 ? Math.round((current / total) * 100) : 0;
        progressFill.style.width = `${percent}%`;
        progressCurrent.textContent = current;
        progressTotal.textContent = total;
        progressPercent.textContent = `(${percent}%)`;
      }

      // 开始处理
      function startProcessing() {
        if (isProcessing) return;

        // 重置状态
        isProcessing = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        progressFill.style.width = '0%';
        progressCurrent.textContent = '0';
        progressTotal.textContent = '0';
        progressPercent.textContent = '(0%)';
        statusLog.innerHTML = '';
        resultSection.style.display = 'none';
        errorList.style.display = 'none';
        errorItems.innerHTML = '';
        lastResponseLength = 0;

        addLog('正在获取视频列表...');

        // 获取视频列表
        fetch('/api/videos')
          .then(response => response.json())
          .then(data => {
            const videos = data.videos || [];
            addLog(`获取到 ${videos.length} 个视频`);

            if (videos.length === 0) {
              addLog('没有找到视频文件，请先添加视频到 static/videos/ 目录', 'error');
              isProcessing = false;
              startBtn.disabled = false;
              stopBtn.disabled = true;
              return;
            }

            // 开始批量处理
            addLog('开始批量生成HLS切片');
            updateProgress(0, videos.length);

            // 发送请求到服务器
            const useGPU = useGPUCheckbox.checked;
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/batch-hls', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.responseType = 'text';

            xhr.onprogress = function (event) {
              if (event.lengthComputable) {
                // 这里可以处理请求进度
              }
            };

            xhr.onreadystatechange = function () {
              if (xhr.readyState === 2) {
                // 响应头已接收，获取处理ID
                currentProcessId = xhr.getResponseHeader('X-Process-ID');
                if (currentProcessId) {
                  addLog(`处理ID: ${currentProcessId}`, 'info');
                }
              } else if (xhr.readyState === 3) {
                // 接收部分响应数据
                const responseText = xhr.responseText;

                // 只处理新接收的数据
                if (responseText.length > lastResponseLength) {
                  const newData = responseText.substring(lastResponseLength);
                  const lines = newData.split('\n');

                  for (const line of lines) {
                    if (line.startsWith('data: ')) {
                      const dataStr = line.substring(6);
                      if (dataStr) {
                        try {
                          const data = JSON.parse(dataStr);

                          switch (data.type) {
                            case 'progress':
                              updateProgress(data.current, data.total);
                              addLog(`正在处理: ${data.video}`);
                              break;
                            case 'success':
                              addLog(`成功: ${data.video}`, 'success');
                              break;
                            case 'error':
                              addLog(`失败: ${data.video} - ${data.message}`, 'error');
                              break;
                            case 'skipped':
                              addLog(`跳过: ${data.video} - ${data.message}`, 'info');
                              break;
                            case 'stop':
                              addLog(`处理已停止: ${data.message}`, 'info');
                              break;
                            case 'complete':
                              updateProgress(data.total, data.total);
                              addLog(`批量生成完成`, 'success');

                              // 显示结果
                              resultSection.style.display = 'block';
                              totalVideos.textContent = data.total;
                              successVideos.textContent = data.success;
                              failedVideos.textContent = data.failed;

                              // 显示失败列表
                              if (data.errors && data.errors.length > 0) {
                                errorList.style.display = 'block';
                                data.errors.forEach(error => {
                                  const li = document.createElement('li');
                                  li.textContent = error;
                                  errorItems.appendChild(li);
                                });
                              }
                              break;
                          }
                        } catch (error) {
                          // 忽略解析错误，可能是不完整的响应
                        }
                      }
                    }
                  }

                  // 更新最后处理的响应长度
                  lastResponseLength = responseText.length;
                }
              } else if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                  // 处理完成
                  addLog('批量生成HLS切片完成！');
                } else {
                  addLog(`处理失败: ${xhr.statusText || '未知错误'} (状态码: ${xhr.status})`, 'error');
                }
                isProcessing = false;
                startBtn.disabled = false;
                stopBtn.disabled = true;
                currentProcessId = null;
              }
            };

            // 发送数据
            xhr.send(JSON.stringify({
              videos: videos,
              useGPU: useGPU
            }));

          })
          .catch(error => {
            addLog(`获取视频列表失败: ${error.message}`, 'error');
            isProcessing = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
          });
      }

      // 停止处理
      function stopProcessing() {
        if (!isProcessing) return;

        addLog('正在停止处理...');

        if (currentProcessId) {
          // 发送停止请求到服务器
          fetch('/api/batch-hls/stop?processId=' + currentProcessId, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          })
            .then(response => response.json())
            .then(data => {
              if (data.message) {
                addLog(`服务器响应: ${data.message}`, 'info');
              } else if (data.error) {
                addLog(`停止失败: ${data.error}`, 'error');
              }
            })
            .catch(error => {
              addLog(`发送停止请求失败: ${error.message}`, 'error');
            });
        }

        // 更新客户端状态
        isProcessing = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        addLog('处理已停止');
      }

      // 扫描视频
      function scanVideos() {
        addLog('正在扫描视频...');
        scanBtn.disabled = true;

        // 发送扫描请求到服务器
        fetch('/api/scan-videos', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              addLog(`扫描完成: ${data.message}`, 'success');
            } else {
              addLog(`扫描失败: ${data.error || '未知错误'}`, 'error');
            }
          })
          .catch(error => {
            addLog(`发送扫描请求失败: ${error.message}`, 'error');
          })
          .finally(() => {
            scanBtn.disabled = false;
          });
      }

      // 搜索和删除功能
      const searchInput = document.getElementById('searchInput');
      const searchBtn = document.getElementById('searchBtn');
      const searchResults = document.getElementById('searchResults');
      const noResults = document.getElementById('noResults');

      // 搜索动画
      function searchAnimes() {
        const keyword = searchInput.value.trim();
        if (keyword === '') {
          clearSearchResults();
          showNoResults('请输入搜索关键词');
          return;
        }

        // 发送搜索请求
        fetch(`/api/animes/search?keyword=${encodeURIComponent(keyword)}`)
          .then(response => response.json())
          .then(data => {
            clearSearchResults();
            if (data.animes && data.animes.length > 0) {
              data.animes.forEach(anime => {
                addSearchResult(anime);
              });
            } else {
              showNoResults('没有找到匹配的动画');
            }
          })
          .catch(error => {
            console.error('搜索失败:', error);
            clearSearchResults();
            showNoResults('搜索失败，请稍后重试');
          });
      }

      // 清除搜索结果
      function clearSearchResults() {
        // 保留noResults元素，清除其他结果
        const resultItems = searchResults.querySelectorAll('.result-item:not(#noResults)');
        resultItems.forEach(item => item.remove());
        noResults.style.display = 'none';
      }

      // 显示无结果提示
      function showNoResults(message) {
        noResults.textContent = message;
        noResults.style.display = 'block';
      }

      // 添加搜索结果
      function addSearchResult(anime) {
        const resultItem = document.createElement('div');
        resultItem.className = 'result-item';
        resultItem.innerHTML = `
        <div class="anime-info">
          <strong>${anime.title}</strong>
          <span style="margin-left: 10px; color: #666;">${anime.episodes} 集</span>
        </div>
        <button class="delete-btn" data-folder="${anime.folder_name}">删除</button>
      `;
        searchResults.appendChild(resultItem);

        // 添加删除按钮事件监听
        const deleteBtn = resultItem.querySelector('.delete-btn');
        deleteBtn.addEventListener('click', function () {
          const folderName = this.getAttribute('data-folder');
          if (confirm(`确定要删除动画 "${anime.title}" 吗？`)) {
            deleteAnime(folderName);
          }
        });
      }

      // 删除动画
      function deleteAnime(folderName) {
        // 发送删除请求
        fetch(`/api/animes/delete?folderName=${encodeURIComponent(folderName)}`, {
          method: 'DELETE'
        })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              // 删除成功，重新搜索
              searchAnimes();
              alert('动画删除成功！');
            } else {
              alert('删除失败: ' + (data.error || '未知错误'));
            }
          })
          .catch(error => {
            console.error('删除失败:', error);
            alert('删除失败，请稍后重试');
          });
      }

      // 事件监听
      startBtn.addEventListener('click', startProcessing);
      stopBtn.addEventListener('click', stopProcessing);
      scanBtn.addEventListener('click', scanVideos);
      searchBtn.addEventListener('click', searchAnimes);
      searchInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          searchAnimes();
        }
      });
    </script>
</body>

</html>