<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{.Title}} - 播放页面</title>
    <link rel="stylesheet" href="/static/css/style.css" />
    <!-- 引入flv.js库 -->
    <script src="/static/js/flv.min.js"></script>
    <!-- 引入hls.js库，用于HLS播放 -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
      /* 外层容器用于控制鼠标事件 */
      .video-container {
        width: 90%;
        max-width: 1200px;
        margin: 20px auto;
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        background: #000;
        cursor: pointer;
        aspect-ratio: 16/9;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .video-player {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      /* 控制栏隐藏样式 */
      .video-player.hide-controls::-webkit-media-controls {
        opacity: 0;
        pointer-events: none;
      }
      /* 兼容Firefox */
      .video-player.hide-controls::-moz-media-controls {
        opacity: 0;
        pointer-events: none;
      }
      /* 兼容IE/Edge */
      .video-player.hide-controls::-ms-media-controls {
        opacity: 0;
        pointer-events: none;
      }
      /* 播放按钮样式 */
      .play-button {
        position: absolute;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 5;
      }
      .play-button:hover {
        background-color: rgba(0, 0, 0, 0.8);
        transform: scale(1.1);
      }
      .play-button::before {
        content: '';
        width: 0;
        height: 0;
        border-style: solid;
        border-width: 30px 0 30px 50px;
        border-color: transparent transparent transparent white;
        margin-left: 10px;
      }
      /* 封面图片样式 */
      .cover-image {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
      }
      /* 加载和缓冲提示样式 */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10;
        display: none;
      }
      
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #4285f4;
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      #loadingText {
        color: white;
        margin-top: 15px;
        font-size: 16px;
      }
      .video-info {
        width: 90%;
        max-width: 1200px;
        margin: 20px auto;
      }
      .episode-selector {
        width: 90%;
        max-width: 1200px;
        margin: 15px auto;
        padding: 10px;
        background: #f5f5f5;
        border-radius: 8px;
      }
      .episode-selector h3 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 16px;
      }
      .episode-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .episode-btn {
        padding: 6px 12px;
        background: #4285f4;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        font-size: 14px;
      }
      .episode-btn:hover {
        background: #3367d6;
      }
      .episode-btn.active {
        background: #ea4335;
      }
      
      /* 加载和缓冲提示样式 */
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 10;
        display: none;
      }
      
      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #4285f4;
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      #loadingText {
        color: white;
        margin-top: 15px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="site-header">
        <a href="/" class="back-btn">← 返回首页</a>
        <a
          href="/search?keyword={{.Keyword | urlquery}}"
          class="back-btn"
          style="margin-left: 10px"
          >← 返回搜索结果</a
        >
        <h1 id="videoTitle">{{.Title}}</h1>
      </header>

      <main>
        <!-- 视频容器 -->
        <div class="video-container" id="videoContainer">
          <!-- 封面图片 -->
          <img id="coverImage" class="cover-image" src="{{.Cover}}" alt="{{.Title}}" />
          <!-- 播放按钮 -->
          <div id="playButton" class="play-button"></div>
          <!-- 初始不隐藏控制栏 -->
          <video
            id="mainVideo"
            class="video-player"
            controls
            preload="metadata"
            poster="{{.Cover}}"
          >
            <source src="{{.VideoURL}}" type="video/mp4" />
            您的浏览器不支持HTML5视频播放，请升级浏览器
          </video>
          <!-- 视频加载和缓冲提示 -->
          <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
            <p id="loadingText">加载中...</p>
          </div>
        </div>

        <div class="video-info">
          <h3>动画简介</h3>
          <p class="summary">{{.Summary}}</p>
        </div>

        {{if .VideoList}}
        <div class="episode-selector">
          <h3>选择集数：</h3>
          <div class="episode-buttons">
            {{range .VideoList}}
            <button
              class="episode-btn {{if eq .Path $.VideoURL}}active{{end}}"
              data-video-url="{{.Path}}"
              data-video-title="{{$.Title}}-{{.FileName}}"
            >
              {{.FileName}}
            </button>
            {{end}}
          </div>
        </div>
        {{end}}
      </main>

      <footer class="site-footer">
        <p>© 2026 动画视频网站 | 本网站仅用于学习交流</p>
      </footer>
    </div>

    <script>
      // 获取核心元素
      const video = document.getElementById("mainVideo");
      const videoContainer = document.getElementById("videoContainer");
      const titleElement = document.getElementById("videoTitle");
      const episodeButtons = document.querySelectorAll(".episode-btn");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const loadingText = document.getElementById("loadingText");
      
      // flv.js播放器实例
      let flvPlayer = null;
      // hls.js播放器实例
      let hlsPlayer = null;
      
      // 显示加载提示
      function showLoading(message = '加载中...') {
        if (loadingOverlay) {
          loadingText.textContent = message;
          loadingOverlay.style.display = 'flex';
        }
      }
      
      // 隐藏加载提示
      function hideLoading() {
        if (loadingOverlay) {
          loadingOverlay.style.display = 'none';
        }
      }
      
      // 检测网络状态
      function getNetworkStatus() {
        if (navigator.connection) {
          const connection = navigator.connection;
          return {
            effectiveType: connection.effectiveType, // 'slow-2g', '2g', '3g', or '4g'
            downlink: connection.downlink, // 预估带宽（Mbps）
            rtt: connection.rtt, // 往返时间（ms）
            saveData: connection.saveData // 是否启用数据保护模式
          };
        }
        return { effectiveType: '4g', downlink: 10, rtt: 50, saveData: false };
      }
      
      // 根据网络状态调整播放器配置
      function getPlayerConfigByNetwork() {
        const network = getNetworkStatus();
        console.log('当前网络状态:', network);
        
        // 基础配置
        let config = {
          maxBufferLength: 60,
          maxBufferSize: 1024 * 1024 * 512,
          maxMaxBufferLength: 90,
          startLevel: -1,
          maxBufferHole: 0.5,
          highBufferWatchdogPeriod: 2,
          nudgeMaxRetry: 5,
          nudgeMinRetry: 2,
          enableWorker: true,
          enableSoftwareAES: true,
          lowLatencyMode: false,
          p2pConfig: false
        };
        
        // 根据网络状态调整配置
        if (network.effectiveType === 'slow-2g' || network.effectiveType === '2g') {
          console.log('网络状态较差，调整播放器配置以适应低带宽');
          config.maxBufferLength = 30; // 减少缓冲长度，加快开始播放
          config.maxBufferSize = 1024 * 1024 * 128; // 减少缓冲大小
          config.startLevel = 0; // 从最低画质开始
        } else if (network.effectiveType === '3g') {
          console.log('网络状态一般，调整播放器配置以平衡质量和流畅度');
          config.maxBufferLength = 45;
          config.maxBufferSize = 1024 * 1024 * 256;
        }
        
        return config;
      }
      
      // 初始化播放器
      function initPlayer(videoUrl) {
        console.log('初始化播放器，视频URL:', videoUrl);
        
        // 显示加载提示
        showLoading('正在加载视频...');
        
        // 销毁现有播放器实例
        if (flvPlayer) {
          flvPlayer.destroy();
          flvPlayer = null;
        }
        if (hlsPlayer) {
          hlsPlayer.destroy();
          hlsPlayer = null;
        }
        
        // 如果视频URL是HLS格式（m3u8），使用hls.js播放
        if (videoUrl.endsWith('.m3u8')) {
          console.log('检测到HLS格式视频，使用hls.js播放');
          
          if (Hls.isSupported()) {
            console.log('浏览器支持hls.js');
            // 获取基于网络状态的播放器配置
            const playerConfig = getPlayerConfigByNetwork();
            console.log('使用播放器配置:', playerConfig);
            // 创建hls.js播放器实例
            hlsPlayer = new Hls(playerConfig);
            
            // 绑定到video元素
            hlsPlayer.attachMedia(video);
            
            // 加载视频
            hlsPlayer.loadSource(videoUrl);
            
            // 监听hls.js事件
            hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() {
              console.log('HLS清单解析完成，开始播放');
              hideLoading();
              video.play().catch(error => {
                console.log('自动播放被浏览器阻止，需要用户手动点击播放:', error);
              });
            });
            
            hlsPlayer.on(Hls.Events.BUFFERING_START, function() {
              console.log('HLS开始缓冲');
              showLoading('视频缓冲中...');
            });
            
            hlsPlayer.on(Hls.Events.BUFFERING_END, function() {
              console.log('HLS缓冲结束');
              hideLoading();
            });
            
            // 监听错误事件
            hlsPlayer.on(Hls.Events.ERROR, function (event, data) {
              console.error('HLS播放错误:', event, data);
              // HLS播放失败时，尝试回退到原MP4文件播放
              if (data.fatal) {
                console.error('HLS播放失败，尝试回退到原MP4文件播放');
                // 构建原MP4文件URL
                var mp4Url = '{{.VideoURL}}';
                // 检查是否是HLS URL
                if (mp4Url.endsWith('.m3u8')) {
                  // 将HLS URL转换为原MP4 URL
                  mp4Url = mp4Url.replace('/static/hls/', '/static/videos/').replace('/playlist.m3u8', '.mp4');
                }
                console.log('回退到原MP4文件:', mp4Url);
                // 使用原MP4文件播放
                video.src = mp4Url;
                video.play().catch(error => {
                  console.log('自动播放被浏览器阻止，需要用户手动点击播放:', error);
                });
                hideLoading();
              }
            });
            
            return true;
          } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            console.log('浏览器原生支持HLS，使用原生播放');
            // 浏览器原生支持HLS，使用原生播放器
            video.src = videoUrl;
            hideLoading();
            return true;
          } else {
            console.error('浏览器不支持HLS播放');
            hideLoading();
            return false;
          }
        } else if (videoUrl.endsWith('.flv') && flvjs.isSupported()) {
          // 如果视频URL是FLV格式，使用flv.js播放
          console.log('检测到FLV格式视频，使用flv.js播放');
          
          // 创建新的flv.js播放器实例
          flvPlayer = flvjs.createPlayer({
            type: 'flv',
            url: videoUrl
          });
          
          // 绑定到video元素
          flvPlayer.attachMediaElement(video);
          
          // 加载视频
          flvPlayer.load();
          
          // 监听flv.js事件
          flvPlayer.on(flvjs.Events.LOADING_COMPLETE, function() {
            console.log('FLV视频加载完成');
            hideLoading();
            video.play().catch(error => {
              console.log('自动播放被浏览器阻止，需要用户手动点击播放:', error);
            });
          });
          
          flvPlayer.on(flvjs.Events.ERROR, function(errorType, errorDetail, errorInfo) {
            console.error('FLV播放错误:', errorType, errorDetail, errorInfo);
            hideLoading();
          });
          
          return true;
        } else {
          // 非HLS/FLV格式，使用原生播放器
          console.log('使用原生播放器播放');
          video.src = videoUrl;
          hideLoading();
          return false;
        }
      }

      // 闲置计时器和控制栏显隐配置
      let idleTimer = null;
      const IDLE_TIME = 3000; // 3秒闲置后隐藏控制栏
      let isControlBarClick = false; // 标记是否点击了控制栏
      let progressSaveTimer = null; // 进度保存计时器
      const PROGRESS_SAVE_INTERVAL = 5000; // 每5秒保存一次进度

      // 播放记录存储相关
      const HISTORY_KEY = 'anime_play_history';
      const MAX_HISTORY_ITEMS = 50; // 最多保存50条记录

      // 获取当前视频信息
      function getCurrentVideoInfo() {
        console.log('获取当前视频信息开始');
        console.log('视频currentTime:', video.currentTime);
        console.log('视频duration:', video.duration);
        console.log('titleElement.textContent:', titleElement.textContent);
        console.log('video.src:', video.src);
        
        const currentTime = video.currentTime;
        const duration = video.duration;
        const progress = duration > 0 ? Math.min(100, (currentTime / duration) * 100) : 0;
        
        // 获取视频URL，确保不为空
        let videoUrl = video.src;
        console.log('原始videoUrl:', videoUrl);
        
        // 修复：如果video.src为空，尝试从模板变量中获取
        if (!videoUrl || videoUrl === '') {
          console.error('video.src为空，尝试从模板变量获取');
          // 从页面中获取视频URL（通过模板传递的变量）
          const videoElement = document.querySelector('source');
          if (videoElement) {
            videoUrl = videoElement.src;
            console.log('从source元素获取到videoUrl:', videoUrl);
          } else {
            console.error('无法获取视频URL');
          }
        }
        
        // 只保存相对路径，移除完整URL前缀
        if (videoUrl && videoUrl.startsWith(window.location.origin)) {
          videoUrl = videoUrl.substring(window.location.origin.length);
          console.log('移除origin后videoUrl:', videoUrl);
        }
        
        // 确保videoUrl不为空
        if (!videoUrl || videoUrl === '') {
          console.error('videoUrl仍然为空，使用默认值');
          videoUrl = '/static/videos/default.mp4';
        }
        
        // 从视频URL中提取动画标题和视频文件名
        const urlParts = videoUrl.split('/');
        console.log('视频URL分割结果:', urlParts);
        
        // 确保urlParts长度足够
        let animeTitle = '未知动画';
        let episode = '未知集数';
        
        if (urlParts.length >= 3) {
          // 动画标题是URL中的倒数第二个部分
          animeTitle = urlParts[urlParts.length - 2];
          // 视频文件名是URL中的最后一个部分
          episode = urlParts[urlParts.length - 1];
        } else if (urlParts.length >= 2) {
          // 如果URL格式不符合预期，使用最后一个部分作为动画标题
          animeTitle = urlParts[urlParts.length - 2];
          episode = urlParts[urlParts.length - 1];
        } else if (urlParts.length >= 1) {
          // 最坏情况，使用整个URL作为动画标题
          animeTitle = urlParts[0];
          episode = urlParts[0];
        }
        
        // 对动画标题和视频文件名进行URL解码
        try {
          animeTitle = decodeURIComponent(animeTitle);
          episode = decodeURIComponent(episode);
        } catch (e) {
          console.error('URL解码失败:', e);
        }
        
        console.log('提取的动画标题:', animeTitle);
        console.log('提取的视频文件名:', episode);
        
        const result = {
          animeTitle: animeTitle,
          episode: episode,
          videoUrl: videoUrl,
          currentTime: currentTime,
          duration: duration,
          progress: progress,
          lastPlayed: new Date().toISOString()
        };
        
        console.log('获取的视频信息:', result);
        return result;
      }

      // 保存播放记录到LocalStorage
      function savePlayHistory() {
        console.log('开始保存播放记录');
        const videoInfo = getCurrentVideoInfo();
        console.log('获取到的视频信息:', videoInfo);
        
        // 检查LocalStorage是否可用
        if (typeof Storage !== "undefined") {
          console.log('LocalStorage可用');
          
          // 检查当前视频是否已经有记录
          let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
          console.log('当前播放记录:', history);
          
          // 修改：每个动画只保留一条最新记录
          // 1. 移除该动画的所有旧记录
          const updatedHistory = history.filter(item => item.animeTitle !== videoInfo.animeTitle);
          console.log('移除旧记录后:', updatedHistory);
          
          // 2. 添加新记录到开头
          updatedHistory.unshift(videoInfo);
          console.log('添加新记录后:', updatedHistory);
          
          // 3. 限制记录数量
          if (updatedHistory.length > MAX_HISTORY_ITEMS) {
            updatedHistory.pop();
            console.log('限制记录数量后:', updatedHistory);
          }
          
          // 保存到LocalStorage
          localStorage.setItem(HISTORY_KEY, JSON.stringify(updatedHistory));
          console.log('播放记录已保存到LocalStorage');
          
          // 验证保存结果
          const savedHistory = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
          console.log('LocalStorage中实际保存的记录:', savedHistory);
        } else {
          console.error('LocalStorage不可用，无法保存播放记录');
        }
      }

      // 定期保存播放进度
      function startProgressSaveTimer() {
        if (progressSaveTimer) clearInterval(progressSaveTimer);
        progressSaveTimer = setInterval(savePlayHistory, PROGRESS_SAVE_INTERVAL);
      }

      // 停止进度保存计时器
      function stopProgressSaveTimer() {
        if (progressSaveTimer) {
          clearInterval(progressSaveTimer);
          progressSaveTimer = null;
        }
      }

      // 显示控制栏
      function showControls() {
        video.classList.remove("hide-controls");
        videoContainer.style.cursor = "default"; // 显示鼠标
        // 清除之前的计时器
        if (idleTimer) clearTimeout(idleTimer);
      }

      // 隐藏控制栏（视频播放时才隐藏）
      function hideControls() {
        if (!video.paused) {
          // 只有视频播放中才隐藏
          video.classList.add("hide-controls");
          videoContainer.style.cursor = "none"; // 隐藏鼠标
        }
      }

      // 重置闲置计时器
      function resetIdleTimer() {
        showControls();
        idleTimer = setTimeout(hideControls, IDLE_TIME);
      }

      // 监听视频容器的鼠标移动
      videoContainer.addEventListener("mousemove", resetIdleTimer);

      // 立即保存一次播放记录，确保初始状态也能保存
      console.log('页面加载完成，立即保存一次播放记录');
      savePlayHistory();
      
      // 监听视频加载事件
      video.addEventListener("loadingstart", () => {
        console.log('视频开始加载');
        showLoading('视频加载中...');
      });
      
      video.addEventListener("canplay", () => {
        console.log('视频可以播放');
        hideLoading();
      });
      
      video.addEventListener("waiting", () => {
        console.log('视频正在缓冲');
        showLoading('视频缓冲中...');
      });
      
      video.addEventListener("playing", () => {
        console.log('视频正在播放');
        hideLoading();
      });
      
      video.addEventListener("error", (e) => {
        console.error('视频播放错误:', e);
        hideLoading();
        alert('视频播放失败，请尝试刷新页面或选择其他集数');
      });
      
      // 监听视频播放/暂停事件，同步控制栏状态
      video.addEventListener("play", () => {
        console.log('视频开始播放，启动进度保存计时器');
        showControls();
        resetIdleTimer(); // 播放时启动计时器
        startProgressSaveTimer(); // 启动进度保存计时器
      });

      video.addEventListener("pause", () => {
        console.log('视频暂停，保存当前进度');
        showControls(); // 暂停时始终显示控制栏
        if (idleTimer) clearTimeout(idleTimer); // 暂停后停止计时器
        stopProgressSaveTimer(); // 停止进度保存计时器
        savePlayHistory(); // 保存当前进度
      });

      // 视频结束时保存进度
      video.addEventListener("ended", () => {
        console.log('视频播放结束，保存最终进度');
        stopProgressSaveTimer();
        savePlayHistory();
      });

      // 页面关闭前保存进度
      window.addEventListener("beforeunload", () => {
        console.log('页面关闭，保存当前进度');
        savePlayHistory();
      });

      // 每30秒自动保存一次播放记录，确保即使视频一直播放也能保存进度
      setInterval(() => {
        if (!video.paused && !video.ended) {
          console.log('30秒自动保存播放记录');
          savePlayHistory();
        }
      }, 30000);

      // 监听控制栏点击（区分原生控制栏操作）
      video.addEventListener("click", (e) => {
        console.log('视频被点击');
        // 点击控制栏时标记，避免和视频画面点击冲突
        isControlBarClick = true;
        setTimeout(() => {
          isControlBarClick = false; // 延迟重置标记
        }, 100);
      });

      // 初始化页面视频
      function initPageVideo() {
        console.log('初始化页面视频');
        // 获取初始视频URL
        const initialVideoUrl = '{{.VideoURL}}';
        // 初始化播放器
        initPlayer(initialVideoUrl);
      }
      
      // 页面加载完成后初始化视频
      window.addEventListener('DOMContentLoaded', () => {
        initPageVideo();
      });
      
      // 视频加载完成后初始化（关闭自动播放后，初始不启动计时器）
      video.addEventListener("loadedmetadata", () => {
        console.log('视频元数据加载完成');
        showControls(); // 初始保持控制栏显示
        
        // 检查是否有当前播放位置参数
        const urlParams = new URLSearchParams(window.location.search);
        const currentTime = urlParams.get('currentTime');
        if (currentTime) {
          const time = parseFloat(currentTime);
          if (!isNaN(time) && time > 0 && time < video.duration) {
            video.currentTime = time;
            console.log('从上次播放位置继续:', time, '秒');
          }
        }
      });

      // 视频源加载完成后保存一次播放记录
      video.addEventListener("loadeddata", () => {
        console.log('视频数据加载完成，保存播放记录');
        savePlayHistory();
      });

      // 播放按钮点击事件
      const playButton = document.getElementById('playButton');
      const coverImage = document.getElementById('coverImage');

      if (playButton) {
        playButton.addEventListener('click', () => {
          console.log('播放按钮被点击');
          if (video.paused) {
            video.play();
            // 隐藏封面和播放按钮
            if (coverImage) {
              coverImage.style.display = 'none';
            }
            playButton.style.display = 'none';
          }
        });
      }

      // 视频播放事件
      video.addEventListener('play', () => {
        console.log('视频开始播放');
        // 隐藏封面和播放按钮
        if (coverImage) {
          coverImage.style.display = 'none';
        }
        if (playButton) {
          playButton.style.display = 'none';
        }
        hideLoading();
        showControls();
        resetIdleTimer();
        startProgressSaveTimer();
      });

      // 视频暂停事件
      video.addEventListener('pause', () => {
        console.log('视频暂停');
        showControls();
        if (idleTimer) clearTimeout(idleTimer);
        stopProgressSaveTimer();
        savePlayHistory();
      });

      // 点击视频容器（区分控制栏和画面）
      videoContainer.addEventListener("click", (e) => {
        console.log('视频容器被点击');
        // 如果点击的是控制栏，只显示控制栏不切换播放状态
        if (isControlBarClick || e.target === video) {
          showControls();
          return;
        }

        // 点击视频画面（非控制栏区域）才切换播放/暂停
        if (video.paused) {
          console.log('点击视频画面，开始播放');
          video.play();
          // 隐藏封面和播放按钮
          if (coverImage) {
            coverImage.style.display = 'none';
          }
          if (playButton) {
            playButton.style.display = 'none';
          }
        } else {
          console.log('点击视频画面，暂停播放');
          video.pause();
        }
        showControls(); // 点击后显示控制栏
      });

      // 集数切换逻辑
      episodeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          console.log('切换集数，保存当前播放记录');
          // 保存当前视频的播放记录
          savePlayHistory();
          
          // 移除所有按钮的active样式
          episodeButtons.forEach((b) => b.classList.remove("active"));
          // 给当前点击的按钮添加active样式
          btn.classList.add("active");

          // 获取视频URL和标题
          const videoUrl = btn.getAttribute("data-video-url");
          const videoTitle = btn.getAttribute("data-video-title");

          // 更新页面标题
          titleElement.textContent = videoTitle;
          document.title = videoTitle + " - 播放页面";
          
          // 初始化播放器
          const isSpecialFormat = initPlayer(videoUrl);
          
          // 点击集数后自动播放
          if (hlsPlayer) {
            // HLS格式，使用hls.js播放
            video.play().catch(error => {
              console.log("自动播放被浏览器阻止，需要用户手动点击播放:", error);
            });
          } else if (flvPlayer) {
            // FLV格式，使用flv.js播放
            flvPlayer.play().catch(error => {
              console.log("自动播放被浏览器阻止，需要用户手动点击播放:", error);
            });
          } else {
            // 其他格式，使用原生播放器
            video.play().catch(error => {
              console.log("自动播放被浏览器阻止，需要用户手动点击播放:", error);
            });
          }

          // 显示控制栏
          showControls();
          if (idleTimer) clearTimeout(idleTimer); // 切换集数后重置计时器
        });
      });
    </script>
  </body>
</html>
