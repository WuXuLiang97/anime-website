<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{.Title}} - 播放页面</title>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="/static/css/style.css">
  <!-- 引入flv.js库 -->
  <script src="/static/js/flv.min.js"></script>
  <!-- 引入hls.js库，用于HLS播放 -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    /* 全局样式重置+基础样式 */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Microsoft Yahei", Arial, sans-serif;
    }



    a {
      text-decoration: none;
      color: #00a1d6;
    }

    a:hover {
      color: #00b8ff;
    }

    .container {
      max-width: 1920px;
      /* 放大最大宽度，适配160px左右边距的宽屏 */
      margin: 0 auto;
      padding: 20px 160px;
      /* 核心修改：上下20px，左右160px间距 */
      width: 100%;
      /* 占满可用宽度 */
    }

    button {
      cursor: pointer;
      border: none;
      background: none;
      transition: all 0.2s ease;
    }

    /* 头部样式 */
    .site-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .back-btn {
      display: inline-block;
      padding: 6px 12px;
      background-color: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 4px;
      color: #333;
    }

    .back-btn:hover {
      background-color: #f8f8f8;
      color: #333;
    }

    #videoTitle {
      font-size: 20px;
      font-weight: 700;
      flex: 1;
      min-width: 200px;
      color: #FFFFFF;
    }

    /* 核心播放区域布局：左播放器+右选集 */
    .play-main-content {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      margin-bottom: 20px;
      width: 100%;
    }

    /* 左侧播放器容器 */
    .video-container {
      flex: 7;
      /* 播放器占7份 */
      min-width: 0;
      /* 解决flex子元素溢出 */
      position: relative;
      background-color: #000;
      border-radius: 4px;
      overflow: hidden;
    }

    .video-player {
      width: 100%;
      height: auto;
      aspect-ratio: 16/9;
      /* 固定16:9视频比例，贴合B站 */
      object-fit: cover;
    }

    /* 隐藏控制栏样式（原有JS逻辑） */
    .video-player.hide-controls {
      cursor: none;
    }

    .video-player.hide-controls::-webkit-media-controls {
      display: none !important;
    }

    /* 右侧选集列表 */
    .episode-selector {
      flex: 3;
      min-width: 280px;
      max-width: 400px;
      border-radius: 4px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-self: flex-start;
      overflow: hidden;
    }

    .episode-selector h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e5e5;
      flex-shrink: 0;
    }

    .episode-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 8px;
      overflow-y: auto;
      flex: 1;
      padding-right: 5px;
    }

    .episode-buttons::-webkit-scrollbar {
      width: 6px;
    }

    .episode-buttons::-webkit-scrollbar-track {
      background: #1E2126;
      border-radius: 3px;
    }

    .episode-buttons::-webkit-scrollbar-thumb {
      background: #4a4a4a;
      border-radius: 3px;
    }

    .episode-buttons::-webkit-scrollbar-thumb:hover {
      background: #5a5a5a;
    }

    .episode-btn {
      padding: 8px 0;
      background-color: #1E2126;
      color: #FFFFFF;
      border-radius: 4px;
      font-size: 14px;
      text-align: center;
    }

    .episode-btn.active {
      background-color: #D24D5C;
      color: #fff;
    }

    .episode-btn:hover:not(.active) {
      background-color: #ECAEB9;
    }

    /* 加载层样式（原有JS逻辑） */
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 99;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #fff;
      border-top: 4px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 10px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* 下方视频简介 */
    .video-info {
      background-color: #fff;
      border-radius: 4px;
      padding: 20px;
      width: 100%;
    }

    .video-info h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .video-info .summary {
      font-size: 14px;
      color: #666;
      line-height: 1.8;
      white-space: pre-wrap;
      /* 保留简介的换行 */
    }

    /* 页脚样式 */
    .site-footer {
      text-align: center;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #e5e5e5;
      font-size: 14px;
      color: #999;
    }

    /* 响应式适配：小屏（手机）变回垂直布局+小间距 */
    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
        /* 移动端恢复小间距，避免内容挤压 */
      }

      .play-main-content {
        flex-direction: column;
        /* 垂直排列 */
      }

      .episode-selector {
        min-width: 100%;
      }

      .video-player {
        aspect-ratio: 16/9;
        /* 手机端也保持16:9 */
      }
    }
  </style>
</head>


<body class="play-page">
  <div class="bili-header">
    <div class="bili-header__bar">
      <ul class="left-entry">
        <li>
          <a href="/" class="entry-title"> <svg width="32" height="32" viewBox="0 0 18 18" fill="none"
              xmlns="http://www.w3.org/2000/svg" class="zhuzhan-icon">
              <path fill-rule="evenodd" clip-rule="evenodd"
                d="M3.73252 2.67094C3.33229 2.28484 3.33229 1.64373 3.73252 1.25764C4.11291 0.890684 4.71552 0.890684 5.09591 1.25764L7.21723 3.30403C7.27749 3.36218 7.32869 3.4261 7.37081 3.49407H10.5789C10.6211 3.4261 10.6723 3.36218 10.7325 3.30403L12.8538 1.25764C13.2342 0.890684 13.8368 0.890684 14.2172 1.25764C14.6175 1.64373 14.6175 2.28484 14.2172 2.67094L13.364 3.49407H14C16.2091 3.49407 18 5.28493 18 7.49407V12.9996C18 15.2087 16.2091 16.9996 14 16.9996H4C1.79086 16.9996 0 15.2087 0 12.9996V7.49406C0 5.28492 1.79086 3.49407 4 3.49407H4.58579L3.73252 2.67094ZM4 5.42343C2.89543 5.42343 2 6.31886 2 7.42343V13.0702C2 14.1748 2.89543 15.0702 4 15.0702H14C15.1046 15.0702 16 14.1748 16 13.0702V7.42343C16 6.31886 15.1046 5.42343 14 5.42343H4ZM5 9.31747C5 8.76519 5.44772 8.31747 6 8.31747C6.55228 8.31747 7 8.76519 7 9.31747V10.2115C7 10.7638 6.55228 11.2115 6 11.2115C5.44772 11.2115 5 10.7638 5 10.2115V9.31747ZM12 8.31747C11.4477 8.31747 11 8.76519 11 9.31747V10.2115C11 10.7638 11.4477 11.2115 12 11.2115C12.5523 11.2115 13 10.7638 13 10.2115V9.31747C13 8.76519 12.5523 8.31747 12 8.31747Z"
                fill="currentColor"></path>
            </svg>
            <span>首页</span>
          </a>
        </li>
        <li class="v-popover-wrap">
          <a href="/search?keyword={{.Keyword | urlquery}}" class="default-entry">← 返回搜索结果</a>

        </li>

      </ul>

    </div>
  </div>

  <div class="container">
    <h1 id="videoTitle">{{.Title}}</h1>
    <main>
      <!-- 核心左右布局：播放器+选集 -->
      <div class="play-main-content">
        <!-- 左侧视频容器 -->
        <div class="video-container" id="videoContainer">
          <video id="mainVideo" class="video-player" controls preload="metadata" poster="{{.Cover}}">
            <source src="{{.VideoURL}}" type="video/mp4" />
            您的浏览器不支持HTML5视频播放，请升级浏览器
          </video>
          <!-- 视频加载和缓冲提示 -->
          <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
            <p id="loadingText">加载中...</p>
          </div>
        </div>

        <!-- 右侧选集列表（有视频列表才显示） -->
        {{if .VideoList}}
        <div class="episode-selector">
          <h3>选集</h3> <!-- 改成B站风格的“选集” -->
          <div class="episode-buttons">
            {{range .VideoList}}
            <button class="episode-btn {{if eq .Path $.VideoURL}}active{{end}}" data-video-url="{{.Path}}"
              data-video-title="{{$.Title}}-{{.FileName}}">
              {{.FileName}}
            </button>
            {{end}}
          </div>
        </div>
        {{end}}
      </div>

      <!-- 下方视频简介（B站风格：选集下侧） -->
      <div class="video-info">
        <h3>动画简介</h3>
        <p class="summary">{{.Summary}}</p>
      </div>
    </main>

    <footer class="site-footer">
      <p>© 2026 动画视频网站 | 本网站仅用于学习交流</p>
    </footer>
  </div>

  <!-- 存储初始视频URL的隐藏元素 -->
  <input type="hidden" id="initialVideoUrl" value="{{.VideoURL}}">

  <!-- 原有JS逻辑完全保留，无需修改 -->
  <script>
    // 获取核心元素
    const video = document.getElementById("mainVideo");
    const videoContainer = document.getElementById("videoContainer");
    const titleElement = document.getElementById("videoTitle");
    const episodeButtons = document.querySelectorAll(".episode-btn");
    const loadingOverlay = document.getElementById("loadingOverlay");
    const loadingText = document.getElementById("loadingText");


    // flv.js播放器实例
    let flvPlayer = null;
    // hls.js播放器实例
    let hlsPlayer = null;

    // 显示加载提示
    function showLoading(message = '加载中...') {
      if (loadingOverlay) {
        loadingText.textContent = message;
        loadingOverlay.style.display = 'flex';
      }
    }

    // 隐藏加载提示
    function hideLoading() {
      if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
      }
    }

    // 检测网络状态
    function getNetworkStatus() {
      if (navigator.connection) {
        const connection = navigator.connection;
        return {
          effectiveType: connection.effectiveType, // 'slow-2g', '2g', '3g', or '4g'
          downlink: connection.downlink, // 预估带宽（Mbps）
          rtt: connection.rtt, // 往返时间（ms）
          saveData: connection.saveData // 是否启用数据保护模式
        };
      }
      return { effectiveType: '4g', downlink: 10, rtt: 50, saveData: false };
    }

    // 根据网络状态调整播放器配置
    function getPlayerConfigByNetwork() {
      const network = getNetworkStatus();
      console.log('当前网络状态:', network);

      // 基础配置
      let config = {
        maxBufferLength: 60,
        maxBufferSize: 1024 * 1024 * 512,
        maxMaxBufferLength: 90,
        startLevel: -1,
        maxBufferHole: 0.5,
        highBufferWatchdogPeriod: 2,
        nudgeMaxRetry: 5,
        nudgeMinRetry: 2,
        enableWorker: true,
        enableSoftwareAES: true,
        lowLatencyMode: false,
        p2pConfig: false
      };

      // 根据网络状态调整配置
      if (network.effectiveType === 'slow-2g' || network.effectiveType === '2g') {
        console.log('网络状态较差，调整播放器配置以适应低带宽');
        config.maxBufferLength = 30; // 减少缓冲长度，加快开始播放
        config.maxBufferSize = 1024 * 1024 * 128; // 减少缓冲大小
        config.startLevel = 0; // 从最低画质开始
      } else if (network.effectiveType === '3g') {
        console.log('网络状态一般，调整播放器配置以平衡质量和流畅度');
        config.maxBufferLength = 45;
        config.maxBufferSize = 1024 * 1024 * 256;
      }

      return config;
    }

    // 初始化播放器
    function initPlayer(videoUrl) {
      console.log('初始化播放器，视频URL:', videoUrl);

      // 显示加载提示
      showLoading('正在加载视频...');

      // 销毁现有播放器实例
      if (flvPlayer) {
        flvPlayer.destroy();
        flvPlayer = null;
      }
      if (hlsPlayer) {
        hlsPlayer.destroy();
        hlsPlayer = null;
      }

      // 如果视频URL是HLS格式（m3u8），使用hls.js播放
      if (videoUrl.endsWith('.m3u8')) {
        console.log('检测到HLS格式视频，使用hls.js播放');

        if (Hls.isSupported()) {
          console.log('浏览器支持hls.js');
          // 获取基于网络状态的播放器配置
          const playerConfig = getPlayerConfigByNetwork();
          console.log('使用播放器配置:', playerConfig);
          // 创建hls.js播放器实例
          hlsPlayer = new Hls(playerConfig);

          // 绑定到video元素
          hlsPlayer.attachMedia(video);

          // 加载视频
          hlsPlayer.loadSource(videoUrl);

          // 监听hls.js事件
          hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function () {
            console.log('HLS清单解析完成，开始播放');
            hideLoading();
            video.play().catch(error => {
              console.log('自动播放被浏览器阻止，需要用户手动点击播放:', error);
            });
          });

          hlsPlayer.on(Hls.Events.BUFFERING_START, function () {
            console.log('HLS开始缓冲');
            showLoading('视频缓冲中...');
          });

          hlsPlayer.on(Hls.Events.BUFFERING_END, function () {
            console.log('HLS缓冲结束');
            hideLoading();
          });

          // 监听错误事件
          hlsPlayer.on(Hls.Events.ERROR, function (event, data) {
            console.error('HLS播放错误:', event, data);
            // HLS播放失败时，尝试回退到原MP4文件播放
            if (data.fatal) {
              console.error('HLS播放失败，尝试回退到原MP4文件播放');
              // 构建原MP4文件URL
              var mp4Url = document.getElementById('initialVideoUrl').value;
              // 检查是否是HLS URL
              if (mp4Url.endsWith('.m3u8')) {
                // 将HLS URL转换为原MP4 URL
                mp4Url = mp4Url.replace('/static/hls/', '/static/videos/').replace('/playlist.m3u8', '.mp4');
              }
              console.log('回退到原MP4文件:', mp4Url);
              // 使用原MP4文件播放
              video.src = mp4Url;
              video.play().catch(error => {
                console.log('自动播放被浏览器阻止，需要用户手动点击播放:', error);
              });
              hideLoading();
            }
          });

          return true;
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
          console.log('浏览器原生支持HLS，使用原生播放');
          // 浏览器原生支持HLS，使用原生播放器
          video.src = videoUrl;
          hideLoading();
          return true;
        } else {
          console.error('浏览器不支持HLS播放');
          hideLoading();
          return false;
        }
      } else if (videoUrl.endsWith('.flv') && flvjs.isSupported()) {
        // 如果视频URL是FLV格式，使用flv.js播放
        console.log('检测到FLV格式视频，使用flv.js播放');

        // 创建新的flv.js播放器实例
        flvPlayer = flvjs.createPlayer({
          type: 'flv',
          url: videoUrl
        });

        // 绑定到video元素
        flvPlayer.attachMediaElement(video);

        // 加载视频
        flvPlayer.load();

        // 监听flv.js事件
        flvPlayer.on(flvjs.Events.LOADING_COMPLETE, function () {
          console.log('FLV视频加载完成');
          hideLoading();
          video.play().catch(error => {
            console.log('自动播放被浏览器阻止，需要用户手动点击播放:', error);
          });
        });

        flvPlayer.on(flvjs.Events.ERROR, function (errorType, errorDetail, errorInfo) {
          console.error('FLV播放错误:', errorType, errorDetail, errorInfo);
          hideLoading();
        });

        return true;
      } else {
        // 非HLS/FLV格式，使用原生播放器
        console.log('使用原生播放器播放');
        video.src = videoUrl;
        hideLoading();
        return false;
      }
    }

    // 闲置计时器和控制栏显隐配置
    let idleTimer = null;
    const IDLE_TIME = 3000; // 3秒闲置后隐藏控制栏
    let isControlBarClick = false; // 标记是否点击了控制栏
    let progressSaveTimer = null; // 进度保存计时器
    const PROGRESS_SAVE_INTERVAL = 10000; // 每10秒保存一次进度

    // 播放记录存储相关
    const HISTORY_KEY = 'anime_play_history';
    const MAX_HISTORY_ITEMS = 50; // 最多保存50条记录

    // 获取视频URL的辅助函数
    function getVideoUrl() {
      // 首先获取初始视频URL，这是最可靠的
      let videoUrl = document.getElementById('initialVideoUrl').value;

      // 如果初始视频URL为空，尝试从source元素获取
      if (!videoUrl || videoUrl === '') {
        const videoElement = document.querySelector('source');
        if (videoElement) {
          videoUrl = videoElement.src;
        }
      }

      // 如果仍然为空，尝试从video元素获取（但跳过blob URL）
      if (!videoUrl || videoUrl === '') {
        const videoSrc = video.src;
        // 跳过blob URL，因为它是临时的
        if (videoSrc && !videoSrc.startsWith('blob:')) {
          videoUrl = videoSrc;
        }
      }

      // 确保videoUrl不为空
      if (!videoUrl || videoUrl === '') {
        videoUrl = '/static/videos/default.mp4';
      }

      // 只保存相对路径，移除完整URL前缀
      if (videoUrl && videoUrl.startsWith(window.location.origin)) {
        videoUrl = videoUrl.substring(window.location.origin.length);
      }

      return videoUrl;
    }

    // 从视频URL中提取信息的辅助函数
    function extractVideoInfoFromUrl(videoUrl) {
      // 从视频URL中提取动画标题和视频文件名
      const urlParts = videoUrl.split('/');

      // 确保urlParts长度足够
      let animeTitle = '未知动画';
      let episode = '未知集数';

      // 检测是否是HLS格式的视频URL
      const isHlsUrl = videoUrl.includes('/hls/') || videoUrl.endsWith('.m3u8');

      if (isHlsUrl && urlParts.length >= 4) {
        // 对于HLS格式的视频，倒数第三个部分是动画标题，倒数第二个部分是集数
        animeTitle = urlParts[urlParts.length - 3];
        episode = urlParts[urlParts.length - 2];
      } else if (urlParts.length >= 3) {
        // 对于普通视频，动画标题是URL中的倒数第二个部分，视频文件名是最后一个部分
        animeTitle = urlParts[urlParts.length - 2];
        episode = urlParts[urlParts.length - 1];

        // 移除文件扩展名
        episode = episode.replace(/\.[^/.]+$/, "");
      } else if (urlParts.length >= 2) {
        // 如果URL格式不符合预期，使用最后一个部分作为动画标题
        animeTitle = urlParts[urlParts.length - 2];
        episode = urlParts[urlParts.length - 1];
      } else if (urlParts.length >= 1) {
        // 最坏情况，使用整个URL作为动画标题
        animeTitle = urlParts[0];
        episode = urlParts[0];
      }

      // 对动画标题和视频文件名进行URL解码
      try {
        animeTitle = decodeURIComponent(animeTitle);
        episode = decodeURIComponent(episode);
      } catch (e) {
        console.error('URL解码失败:', e);
      }

      return { animeTitle, episode };
    }

    // 获取当前视频信息
    function getCurrentVideoInfo() {
      console.log('获取当前视频信息开始');
      console.log('视频currentTime:', video.currentTime);
      console.log('视频duration:', video.duration);
      console.log('titleElement.textContent:', titleElement.textContent);
      console.log('video.src:', video.src);

      const currentTime = video.currentTime;
      const duration = video.duration;
      const progress = duration > 0 ? Math.min(100, (currentTime / duration) * 100) : 0;

      // 使用辅助函数获取视频URL
      const videoUrl = getVideoUrl();
      console.log('获取的videoUrl:', videoUrl);

      // 使用辅助函数从URL中提取信息
      const { animeTitle, episode } = extractVideoInfoFromUrl(videoUrl);
      console.log('提取的动画标题:', animeTitle);
      console.log('提取的视频文件名:', episode);

      const result = {
        animeTitle: animeTitle,
        episode: episode,
        videoUrl: videoUrl,
        currentTime: currentTime,
        duration: duration,
        progress: progress,
        lastPlayed: new Date().toISOString()
      };

      console.log('获取的视频信息:', result);
      return result;
    }

    // 保存播放记录到后端API
    function savePlayHistory() {
      console.log('开始保存播放记录');
      const videoInfo = getCurrentVideoInfo();
      console.log('获取到的视频信息:', videoInfo);

      // 只有当视频URL有效且duration大于0时才保存播放记录
      if (!videoInfo.videoUrl || videoInfo.duration <= 0) {
        console.log('视频URL无效或duration为0，跳过保存播放记录');
        return;
      }

      // 从URL参数中获取keyword
      const urlParams = new URLSearchParams(window.location.search);
      const keyword = urlParams.get('keyword') || '';

      // 准备API请求数据
      const requestData = {
        videoId: videoInfo.videoUrl,
        animeTitle: videoInfo.animeTitle,
        episode: videoInfo.episode,
        videoUrl: videoInfo.videoUrl,
        currentTime: videoInfo.currentTime,
        duration: videoInfo.duration,
        progress: videoInfo.progress,
        keyword: keyword
      };

      console.log('准备发送的API请求数据:', requestData);

      // 发送API请求
      fetch('/api/play-history/save', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
      })
        .then(response => {
          if (!response.ok) {
            throw new Error('API请求失败: ' + response.status);
          }
          return response.json();
        })
        .then(data => {
          console.log('播放记录保存成功:', data);
        })
        .catch(error => {
          console.error('保存播放记录失败:', error);
          // API调用失败时，尝试使用localStorage作为备份
          console.log('API调用失败，尝试使用localStorage作为备份');
          if (typeof Storage !== "undefined") {
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
            const updatedHistory = history.filter(item => item.animeTitle !== videoInfo.animeTitle);
            // 添加keyword到videoInfo
            videoInfo.keyword = keyword;
            updatedHistory.unshift(videoInfo);
            if (updatedHistory.length > MAX_HISTORY_ITEMS) {
              updatedHistory.pop();
            }
            localStorage.setItem(HISTORY_KEY, JSON.stringify(updatedHistory));
            console.log('播放记录已备份到LocalStorage');
          }
        });
    }

    // 定期保存播放进度
    function startProgressSaveTimer() {
      if (progressSaveTimer) clearInterval(progressSaveTimer);
      progressSaveTimer = setInterval(savePlayHistory, PROGRESS_SAVE_INTERVAL);
    }

    // 停止进度保存计时器
    function stopProgressSaveTimer() {
      if (progressSaveTimer) {
        clearInterval(progressSaveTimer);
        progressSaveTimer = null;
      }
    }

    // 显示控制栏
    function showControls() {
      video.classList.remove("hide-controls");
      videoContainer.style.cursor = "default"; // 显示鼠标
      // 清除之前的计时器
      if (idleTimer) clearTimeout(idleTimer);
    }

    // 隐藏控制栏（视频播放时才隐藏）
    function hideControls() {
      if (!video.paused) {
        // 只有视频播放中才隐藏
        video.classList.add("hide-controls");
        videoContainer.style.cursor = "none"; // 隐藏鼠标
      }
    }

    // 重置闲置计时器
    function resetIdleTimer() {
      showControls();
      idleTimer = setTimeout(hideControls, IDLE_TIME);
    }

    // 监听视频容器的鼠标移动
    videoContainer.addEventListener("mousemove", resetIdleTimer);

    // 立即保存一次播放记录，确保初始状态也能保存
    console.log('页面加载完成，立即保存一次播放记录');
    savePlayHistory();

    // 监听视频加载事件
    video.addEventListener("loadingstart", () => {
      console.log('视频开始加载');
      showLoading('视频加载中...');
    });

    video.addEventListener("canplay", () => {
      console.log('视频可以播放');
      hideLoading();
    });

    video.addEventListener("waiting", () => {
      console.log('视频正在缓冲');
      showLoading('视频缓冲中...');
    });

    video.addEventListener("playing", () => {
      console.log('视频正在播放');
      hideLoading();
    });

    video.addEventListener("error", (e) => {
      console.error('视频播放错误:', e);
      hideLoading();
      alert('视频播放失败，请尝试刷新页面或选择其他集数');
    });

    // 监听视频播放/暂停事件，同步控制栏状态
    video.addEventListener("play", () => {
      console.log('视频开始播放，启动进度保存计时器');
      hideLoading();
      showControls();
      resetIdleTimer(); // 播放时启动计时器
      startProgressSaveTimer(); // 启动进度保存计时器
    });

    video.addEventListener("pause", () => {
      console.log('视频暂停，保存当前进度');
      showControls(); // 暂停时始终显示控制栏
      if (idleTimer) clearTimeout(idleTimer); // 暂停后停止计时器
      stopProgressSaveTimer(); // 停止进度保存计时器
      savePlayHistory(); // 保存当前进度
    });

    // 视频结束时保存进度
    video.addEventListener("ended", () => {
      console.log('视频播放结束，保存最终进度');
      stopProgressSaveTimer();
      savePlayHistory();
    });

    // 页面关闭前保存进度
    window.addEventListener("beforeunload", () => {
      console.log('页面关闭，保存当前进度');
      savePlayHistory();
    });

    // 监听控制栏点击（区分原生控制栏操作）
    video.addEventListener("click", (e) => {
      console.log('视频被点击');
      // 点击控制栏时标记，避免和视频画面点击冲突
      isControlBarClick = true;
      setTimeout(() => {
        isControlBarClick = false; // 延迟重置标记
      }, 100);
    });

    // 初始化页面视频
    function initPageVideo() {
      console.log('初始化页面视频');
      // 首先检查URL中的video参数
      const urlParams = new URLSearchParams(window.location.search);
      let videoUrl = urlParams.get('video');

      // 如果URL中没有video参数，使用模板变量中的初始视频URL
      if (!videoUrl || videoUrl === '') {
        videoUrl = '{{.VideoURL}}';
      }

      console.log('使用的视频URL:', videoUrl);
      // 初始化播放器
      initPlayer(videoUrl);
    }

    // 页面加载完成后初始化视频
    window.addEventListener('DOMContentLoaded', () => {
      initPageVideo();
    });

    // 视频加载完成后初始化（关闭自动播放后，初始不启动计时器）
    video.addEventListener("loadedmetadata", () => {
      console.log('视频元数据加载完成');
      showControls(); // 初始保持控制栏显示

      // 同步选集列表高度
      syncEpisodeSelectorHeight();

      // 检查是否有当前播放位置参数
      const urlParams = new URLSearchParams(window.location.search);
      const currentTime = urlParams.get('currentTime');
      if (currentTime) {
        const time = parseFloat(currentTime);
        if (!isNaN(time) && time > 0 && time < video.duration) {
          video.currentTime = time;
          console.log('从上次播放位置继续:', time, '秒');
        }
      }
    });

    // 视频源加载完成后保存一次播放记录
    video.addEventListener("loadeddata", () => {
      console.log('视频数据加载完成，保存播放记录');
      savePlayHistory();
    });

    // 点击视频容器（区分控制栏和画面）
    videoContainer.addEventListener("click", (e) => {
      console.log('视频容器被点击');
      // 如果点击的是控制栏，只显示控制栏不切换播放状态
      if (isControlBarClick || e.target === video) {
        showControls();
        return;
      }

      // 点击视频画面（非控制栏区域）才切换播放/暂停
      if (video.paused) {
        console.log('点击视频画面，开始播放');
        video.play();
      } else {
        console.log('点击视频画面，暂停播放');
        video.pause();
      }
      showControls(); // 点击后显示控制栏
    });

    // 集数切换逻辑
    episodeButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        console.log('切换集数，保存当前播放记录');
        // 保存当前视频的播放记录
        savePlayHistory();

        // 移除所有按钮的active样式
        episodeButtons.forEach((b) => b.classList.remove("active"));
        // 给当前点击的按钮添加active样式
        btn.classList.add("active");

        // 获取视频URL和标题
        const videoUrl = btn.getAttribute("data-video-url");
        const videoTitle = btn.getAttribute("data-video-title");

        // 更新页面标题
        titleElement.textContent = videoTitle;
        document.title = videoTitle + " - 播放页面";

        // 更新初始视频URL，确保保存的是当前集数的播放记录
        document.getElementById('initialVideoUrl').value = videoUrl;

        // 清除URL中的currentTime参数，避免切换剧集后从旧进度开始
        const url = new URL(window.location.href);
        url.searchParams.delete('currentTime');
        window.history.replaceState({}, '', url.toString());

        // 初始化播放器
        const isSpecialFormat = initPlayer(videoUrl);

        // 点击集数后自动播放
        if (hlsPlayer) {
          // HLS格式，使用hls.js播放
          video.play().catch(error => {
            console.log("自动播放被浏览器阻止，需要用户手动点击播放:", error);
          });
        } else if (flvPlayer) {
          // FLV格式，使用flv.js播放
          flvPlayer.play().catch(error => {
            console.log("自动播放被浏览器阻止，需要用户手动点击播放:", error);
          });
        } else {
          // 其他格式，使用原生播放器
          video.play().catch(error => {
            console.log("自动播放被浏览器阻止，需要用户手动点击播放:", error);
          });
        }

        // 显示控制栏
        showControls();
        if (idleTimer) clearTimeout(idleTimer);
      });
    });

    // 同步选集列表高度与播放器高度
    function syncEpisodeSelectorHeight() {
      const video = document.getElementById('mainVideo');
      const episodeSelector = document.querySelector('.episode-selector');
      if (video && episodeSelector) {
        const videoRect = video.getBoundingClientRect();
        episodeSelector.style.maxHeight = videoRect.height + 'px';
      }
    }

    // 页面加载和窗口大小变化时同步高度
    window.addEventListener('load', syncEpisodeSelectorHeight);
    window.addEventListener('resize', syncEpisodeSelectorHeight);
  </script>
</body>

</html>